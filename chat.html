<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>对话聊天</title>
  <link rel="stylesheet" href="{:REGISTER_PUBLIC}css/common/main.css">
  <link rel="stylesheet" href="{:REGISTER_PUBLIC}css/common/vant.css">
  <link rel="stylesheet" href="{:REGISTER_PUBLIC}css/chat/chat.css?v=<?php echo time(); php?>">
</head>

<body>
  <div id="app" :style="{'min-height': innerPage}" v-cloak>
    <!-- 聊天消息区 -->
    <van-list class="message_wrap" v-model="loading" :finished="finished" finished-text="没有更多了" :immediate-check="false"
      direction="up" @load="onLoadList">
      <div :class="[item.from == sid ? 'item reverse' : 'item row']" v-for="(item, index) in messageList" :key="index">
        <div class="avatar">
          <img :src="item.data.from.avatar || default_avatar" alt="">
        </div>
        <div class="content">
          <div class="text" v-if="item.data.typ == 100">{{item.data.content.txt}}</div>
          <div class="img" v-if="item.data.typ == 104">
            <img :src="item.data.content.img" alt="">
          </div>
          <div class="card" v-if="item.data.typ == 102" @click="goUserCard(item.data.content.card_id)">
            <div class="title">{{item.data.content.card_name}}的{{item.data.content.card_brand}}的微名片请惠存！</div>
            <div class="inner_wrap">
              <div class="img_wrap">
                <img :src="item.data.content.card_avatar" alt="">
              </div>
              <div class="right">
                <p>姓名：{{item.data.content.card_name}}</p>
                <p>品牌：{{item.data.content.card_brand}}</p>
              </div>
            </div>
            <div class="footer">
              <p>名片</p>
            </div>
          </div>
          <div class="news" @click="_gOtherNews(item.data.content)" v-if="item.data.typ == 103">
            <div class="title van-multi-ellipsis--l2">{{item.data.content.article_title}}</div>
            <div class="bottom">
              <p class="van-multi-ellipsis--l2">{{item.data.content.article_desc}}</p>
              <img :src="item.data.content.article_pic" alt="">
            </div>
          </div>
          <div class="audio" v-if="item.data.typ == 101">
            <div class="audio_content" @click="goPlayAudio(item)">
              <div class="sound_icon">
                <img src="{:REGISTER_PUBLIC}img/chat/sound.png" alt="" v-if="!isAudioPlay">
                <img src="{:REGISTER_PUBLIC}img/chat/sound_on.gif" alt="" v-else>
              </div>
              <p class="audio_length">{{item.data.content.time}}"</p>
            </div>
            <div class="noread" v-if="!item.data.content.is_listen"></div>
            <audio :src="item.data.content.audio" ref="audio" controls style="display: none;"></audio>
          </div>
        </div>
      </div>
    </van-list>
    <!-- <audio src="" ref="audio" style="display: none;"></audio> -->
    <!-- 聊天输入区 -->
    <div id="chat-footer">
      <div class="input_wrap">
        <div class="left_wrap" @click="toggleContent">
          <img :src="minus" alt="" v-if="showContent">
          <img :src="plus" alt="" v-else>
        </div>
        <div class="content">
          <input type="text" v-model="typingText" @blur="onBlur">
          <div class="icon">
            <img :src="smile" alt="" @click="faceContent">
          </div>
        </div>
        <div class="submit" @click="sendText">发送</div>
      </div>
      <div class="content_wrap" v-show="showContent">
        <div class="apply_wrap" v-if="!faceShow">
          <div class="item" v-for="(item, index) in applyList" :key="index" @click="applyItem(item.type)">
            <van-uploader :after-read="afterRead" v-if="index === 0">
              <img :src="item.icon" alt="" />
              <p>{{ item.title }}</p>
            </van-uploader>
            <template v-else-if="index === 3">
              <img :src="item.icon" alt="" />
              <p>{{isStartRecord ? '停止录音' : item.title }}</p>
            </template>
            <template v-else>
              <img :src="item.icon" alt="" />
              <p>{{ item.title }}</p>
            </template>
          </div>
        </div>
        <div class="emoji_wrap" v-if="faceShow">
          <ul>
            <li v-for="(item, index) in faceList" :key="index" @click="getBrow(index)">
              {{ item }}
            </li>
          </ul>
        </div>
      </div>
    </div>
    <!-- 资讯弹窗列表 -->
    <van-popup v-model="showNews">
      <div class="news_list">
        <div class="item" v-for="(item, index) in newsList" :key="index" @click="sendNews(item)">
          <div class="left_wrap">
            <img :src="item.cover" alt="">
          </div>
          <div class="right_wrap">
            <p class="van-multi-ellipsis--l2">{{item.description}}</p>
          </div>
        </div>
      </div>
    </van-popup>
  </div>
</body>

<script src="{:REGISTER_PUBLIC}js/vue.min.js"></script>
<script src="{:REGISTER_PUBLIC}js/vue-resource.min.js"></script>
<script src="{:REGISTER_PUBLIC}js/vant.min.js?v=1.2"></script>
<script src="{:REGISTER_PUBLIC}js/jweixin-1.1.0.js"></script>
<script src="{:REGISTER_PUBLIC}js/vconsole.min.js"></script>

<script>
  new VConsole();
  const URL = "{:H5_DOMAIN}";
  const API_URL = "{:API_DOMAIN}";
  const ROUTE_DETAIL_DOMAIN = "{:ROUTE_DETAIL_DOMAIN}"; //文章详情授权

  new Vue({
    el: '#app',
    data() {
      return {
        option: {}, // 页面url参数
        userInfo: {},
        token: '',
        sid: '',
        connectKey: '',
        ws: null, //websocket对象
        isGroup: false, // 是否群聊
        default_avatar: '{:REGISTER_PUBLIC}img/avatar/default_avatar.jpg',
        authUrl: "http://123.206.118.205:10800/auth?timestamp=" + new Date().valueOf(),
        wsServer: "ws://123.206.118.205:10800/io?timestamp=" + new Date().valueOf(), //ws请求地址
        lastid: 0, // 聊天记录分页id
        page: 1, // 页码
        pageSize: 20, // 每页条数
        loading: false, // 分页加载
        finished: false, // 结束分页加载
        newsList: [], //资讯列表
        // footer
        minus: '{:REGISTER_PUBLIC}img/chat/minus.png',
        plus: '{:REGISTER_PUBLIC}img/chat/plus.png',
        smile: '{:REGISTER_PUBLIC}img/chat/smile.png',
        showContent: false, //显示面板
        faceShow: false, //显示表情
        showNews: false, // 显示资讯列表
        isStartRecord: false, // 是否正在录音
        isAudioPlay: false, // 是否在播放语音
        typingText: "",
        faceString: "", //选中表情
        faceData: {}, //表情json
        faceList: [], //表情
        messageList: [],
        applyList: [{
          type: "image",
          icon: '{:REGISTER_PUBLIC}img/chat/card.png',
          title: "图片",
        }, {
          type: "news",
          icon: '{:REGISTER_PUBLIC}img/chat/news.png',
          title: "资讯",
        }, {
          type: "card",
          icon: '{:REGISTER_PUBLIC}img/chat/card.png',
          title: "名片",
        }, {
          type: "voice",
          icon: '{:REGISTER_PUBLIC}img/chat/voice.png',
          title: "语音",
        }, ],
      }
    },
    computed: {
      innerPage() {
        return window.innerHeight + 'px'
      }
    },
    mounted() {
      // this.$nextTick(() => {
      //   let audio = this.$refs.audio;
      //   console.log(audio);
      //   audio.load();
      // })
      this.getUserInfo()
      this.initWxSDK()
      window.scrollTo(0, document.body.scrollHeight)
    },
    updated() {
      // console.log('updated!!');
      // window.scrollTo(0, document.body.scrollHeight)
    },
    methods: {
      // 获取url参数 判断单聊群聊
      getUrlQuery() {
        this.option.id = getQueryString('id')
        this.option.sid = getQueryString('sid')
        if (this.option.sid) {
          this.isGroup = false
          this.getChatDetail(0, this.option.id, 1001)
        } else {
          this.isGroup = true
        }

        // 获取url参数
        function getQueryString(name, url) {
          var url = url || window.location.href;
          var reg = new RegExp("(^|&|/?)" + name + "=([^&|/#?]*)(&|/?|$)", "i");
          var r = url.substr(1).match(reg);
          if (r != null) {
            return r[2];
          }
          return null;
        }
      },
      // 获取个人信息
      getUserInfo() {
        this.$http.get(URL + "/H5/Visitor/getLoginInfo").then(
          res => {
            const {
              errCode,
              data,
              msg
            } = res.body;
            if (errCode === 0) {
              this.token = data.token;
              this.userInfo = data.userInfo
              this.getUrlQuery()
              this.getEmoji()
              this.getOnlineMsg()
              this.getNewsList()
            }
          },
          err => {
            this.$toast({
              type: 'fail',
              message: '授权失败',
              duration: 1500,
            });
          }
        );
      },
      // 登录获取信息
      getOnlineMsg() {
        this.$http.get(URL + "/register/friend/online", {
          params: {
            token: this.token
          }
        }).then(
          res => {
            const {
              errCode,
              data,
              msg
            } = res.body;
            if (errCode === 0) {
              this.getWsAuth()
            }
          },
          err => {
            this.$toast({
              type: 'fail',
              message: '登录失败',
              duration: 1500,
            });
          }
        );
      },
      // ws授权
      getWsAuth() {
        let uri = this.authUrl;
        let token = this.token;
        if (token != null && token !== undefined) {
          uri += "&token=" + token;
        }
        this.$http.get(uri).then(
          res => {
            const {
              code,
              data,
              message
            } = res.body;
            if (code === 1) {
              this.connectKey = data.key;
              this.sid = data.sid;
              this.initWebSocket()
            }
          },
          err => {
            this.$toast({
              type: 'fail',
              message: '登录失败',
              duration: 1500,
            });
          }
        );
      },
      // 请求表情json
      getEmoji() {
        this.$http.get(URL + "/register/friend/emoji", {
          params: {
            token: this.token
          }
        }).then(
          res => {
            const {
              errCode,
              data,
              msg
            } = res.body;
            if (errCode === 0) {
              this.faceData = data
              for (let i in this.faceData) {
                this.faceList.push(this.faceData[i].char);
              }
            }
          },
          err => {
            console.log('getEmoji 请求失败');
          }
        );
      },
      // 获取历史消息
      getChatDetail(last = 0, id, type) {
        this.$http.get(URL + "/register/friend/chat_detail", {
          params: {
            token: this.token,
            lastid: last,
            id: id,
            class: type
          }
        }).then(
          res => {
            const {
              errCode,
              data,
              msg
            } = res.body;
            if (errCode === 0) {
              let self = this;
              let result = data.list;
              this.lastid = data.lastid;
              if (data == null || result.length == 0) {
                // 加载结束
                this.loading = false;
                this.finished = true;
                return false
              }
              result.forEach(item => {
                // if (item.data.typ == 101) {
                //   let audioElement = new Audio();
                //   audioElement.src = item.data.content.audio;
                //   if (audioElement) {
                //     audioElement.addEventListener('canplay', () => {
                //       console.log(222);
                //       let duration = Math.round(audioElement.duration);
                //       self.$set(item.data.content, 'time', duration);
                //     })
                //   }
                // }
                this.messageList.unshift(item);
              })
              if (result.length < this.pageSize) {
                // 一页不足的情况
                this.loading = false;
                this.finished = true;
              } else {
                this.loading = false;
              }

              this.$nextTick(() => {
                let audio = self.$refs.audio;
                console.log(audio);
                
                audio.forEach(item => {
                  item.load();
                  item.addEventListener('canplay', () => {
                    console.log(222);
                    let duration = Math.round(item.duration);
                    console.log(duration);
                    // self.$set(item.data.content, 'time', duration);
                  })
                })
              })

              // audio.forEach(item => {
              //   item.addEventListener('canplay', () => {
              //     console.log(222);
              //     let duration = Math.round(audio.duration);
              //     self.$set(item.data.content, 'time', duration);
              //   })
              // })
            }
          },
          err => {
            console.log('getChatDetail 请求失败');
          }
        );
      },
      // 发送消息请求
      sendChatMessage(obj) {
        this.$http.post(URL + "/register/friend/send_notice", obj, {
          emulateJSON: true
        }).then(
          res => {
            const {
              errCode,
              data,
              msg
            } = res.body;
            if (errCode === 0) {
              this.showContent = false;
              this.faceShow = false;
              this.ws.send(4 + JSON.stringify(data))
              this.messageList.push(data)
            }
          },
          err => {
            console.log('sendChatMessage 请求失败');
          }
        );
      },
      // 请求设置已读消息
      getChatRead(type, id) {
        this.$http.get(URL + "/register/friend/read", {
          params: {
            token: this.token,
            class: type,
            id: id,
          }
        }).then(
          res => {
            const {
              errCode,
              data,
              msg
            } = res.body;
            if (errCode === 0) {}
          },
          err => {
            console.log('getChatRead 请求失败');
          }
        );
      },
      // 最近热门列表
      getNewsList() {
        this.$http
          .get(API_URL + "/news/getNewsList", {
            params: {
              token: this.token,
              vid: this.userInfo.vid,
              bid: this.userInfo.bid,
              ccid: -2,
              cate_id: this.userInfo.cate_id,
              page: 1,
              pageSize: 20,
            },
          })
          .then(
            res => {
              if (res.body.errCode === 0) {
                const data = res.body.data;
                if (data) {
                  this.newsList = data;
                }
              }
            },
            err => {
              console.log("getNewsList 请求失败");
            }
          );
      },
      // 载入微信sdk
      initWxSDK() {
        this.$http.get(`${URL}/H5/Share/getSign`, {
          params: {
            url: location.href
          }
        }).then(
          (response) => {
            if (response.body.errCode == 0) {
              let res = response.data.data;
              wx.config({
                debug: false,
                appId: res.appId,
                timestamp: res.timestamp,
                nonceStr: res.nonceStr,
                signature: res.signature,
                jsApiList: [
                  "startRecord",
                  "stopRecord",
                  "playVoice",
                  "pauseVoice",
                  "stopVoice",
                  "uploadVoice",
                ],
              });
              wx.ready(function () {
                // console.log('sdk ready');
              });
            } else {
              console.log("code is not 200");
            }
          },
          (err) => {
            console.log("请求失败");
          }
        );
      },
      // 载入websocket
      initWebSocket() {
        if (!"WebSocket" in window) {
          this.$tost({
            type: 'fail',
            message: '您的浏览器不支持WebSocket!',
            duration: 2000,
          })
          return false
        }
        let self = this;
        let wsServer = this.wsServer + "&sid=" + this.sid + "&key=" + this.connectKey;
        var ws = new WebSocket(wsServer);
        ws.onopen = function (e) {
          console.log('onopen>>', e);
        };
        ws.onmessage = function (e) {
          console.log('onmessage>>', e.data);
          let str = e.data.substring(1);
          self.messageList.push(JSON.parse(str))
          if (this.isGroup) {
            self.getChatRead(1002, self.option.id)
          } else {
            self.getChatRead(1001, self.option.id)
          }
        };
        ws.onerror = function (e) {
          console.log('onerror>>', e);
        };
        ws.onclose = function (e) {
          console.log('onclose>>', e);
        };
        this.ws = ws
      },
      // 上拉加载请求方法
      onLoadList() {
        if (this.messageList.length >= this.pageSize) {
          setTimeout(() => {
            if (this.isGroup) {
              this.getChatDetail(this.lastid, this.option.id, 1002)
            } else {
              this.getChatDetail(this.lastid, this.option.id, 1001)
            }
          }, 600)
        }
      },
      // 切换显示面板
      toggleContent() {
        this.showContent = !this.showContent;
        this.faceShow = false;
      },
      // 点击面板选项
      applyItem(type) {
        switch (type) {
          case "news":
            console.log("news");
            this.showNews = true;
            this.showContent = false;
            break;
          case "card":
            console.log("card");
            let obj = {
              token: this.token,
              class: 1001,
              type: 102,
              toid: this.option.id
            }
            this.$dialog.alert({
                title: '消息提示',
                message: '确认发送您的名片吗？',
                confirmButtonColor: '#FF730C',
                showCancelButton: true,
              })
              .then(() => {
                this.sendChatMessage(obj);
              })
              .catch(() => {
                // ...
              });
            break;
          case "voice":
            console.log("voice");
            if (!this.isStartRecord) {
              this.startRecord()
            } else {
              this.stopRecord()
            }
            break;
          default:
            break;
        }
      },
      // 显示表情
      faceContent() {
        if (!this.showContent) {
          this.toggleContent();
        }
        this.faceShow = !this.faceShow;
      },
      // 获取用户点击之后的标签 ，存放到输入框内
      getBrow(index) {
        for (let i in this.faceList) {
          if (index == i) {
            this.faceString = this.faceList[index];
            this.typingText += this.faceString;
          }
        }
      },
      // 输入框失焦
      onBlur(e) {
        // console.log(e);
        window.scrollTo(0, document.body.scrollHeight)
      },
      // 图片上传
      afterRead(file) {
        // console.log(file);
        let obj = {
          token: this.token,
          class: 1001,
          type: 104,
          toid: this.option.id,
          file: file.content
        }
        this.sendChatMessage(obj)
      },
      // 名片跳转
      goUserCard(id) {
        location.href = `/register/page/user_card?mid=${id}`
      },
      // 发送文本消息
      sendText() {
        let obj = {
          token: this.token,
          class: 1001,
          type: 100,
          toid: this.option.id,
          content: this.typingText
        }
        this.sendChatMessage(obj)
        this.typingText = null;
        this.showContent = false;
        this.faceShow = false;
      },
      // 点击发送选中文章
      sendNews(item) {
        let obj = {
          token: this.token,
          class: 1001,
          type: 103,
          toid: this.option.id,
          cid: item.cid,
          article_id: item.id,
          article_title: item.title,
          article_desc: item.description,
          article_pic: item.cover
        }
        this.$dialog.alert({
            title: '消息提示',
            message: '确认发送该文章吗？',
            confirmButtonColor: '#FF730C',
            showCancelButton: true,
          })
          .then(() => {
            this.sendChatMessage(obj);
            this.showNews = false;
          })
          .catch(() => {
            // ...
          });
      },
      // 跳转文章详情
      _gOtherNews(item) {
        location.href =
          ROUTE_DETAIL_DOMAIN +
          "?nid=" +
          item.article_id +
          "&cid=" +
          item.cid +
          "&uid=" +
          this.userInfo.vid +
          "&proid=" +
          this.userInfo.vid +
          "&otherBid=" +
          this.userInfo.bid;
      },
      // 点击录音
      startRecord() {
        let self = this;
        wx.startRecord({
          success: function (res) {
            self.isStartRecord = true;
          },
          cancel: function () {
            console.log('用户拒绝授权录音');
          },
          fail: function (res) {
            //录音失败
            console.log('fail', res);
          }
        })
      },
      // 点击停止录音
      stopRecord() {
        console.log('>>>>>>>>>>停止语音');
        let self = this;
        wx.stopRecord({
          success: function (res) {
            let voiceId = res.localId;
            self.isStartRecord = false;
            self.upLoadRecord(voiceId);
            console.log('stopRecord', res);
          },
          fail: function (res) {
            alert(JSON.stringify(res));
          }
        });
      },
      // 上传语音
      upLoadRecord(id) {
        let self = this;
        wx.uploadVoice({
          localId: id,
          isShowProgressTips: 1, // 默认为1，显示进度提示
          success: function (res) {
            let obj = {
              token: self.token,
              class: 1001,
              type: 101,
              toid: self.option.id,
              file: res.serverId
            }
            self.$dialog.alert({
                title: '消息提示',
                message: '确认发送语音吗？',
                confirmButtonColor: '#FF730C',
                showCancelButton: true,
              })
              .then(() => {
                self.sendChatMessage(obj)
              })
              .catch(() => {
                // ...
              });
          }
        });
      },
      // 播放/暂停音频
      goPlayAudio(item) {
        let mpeg = item.data.content.audio;
        let myAudio = new Audio(mpeg);
        this.isAudioPlay = !this.isAudioPlay;
        if (myAudio) {
          myAudio.addEventListener('ended', () => {
            console.log('stop');
            this.isAudioPlay = false;
          })
          if (!this.isAudioPlay) {
            console.log('pause');
            myAudio.pause();
          } else {
            console.log('play');
            myAudio.play();
          }
        }
      }
    }
  })
</script>

</html>