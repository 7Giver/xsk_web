<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>名片</title>

  <link rel="stylesheet" href="{:REGISTER_PUBLIC}css/common/main.css">
  <link rel="stylesheet" href="{:REGISTER_PUBLIC}css/common/vant.css">
  <link rel="stylesheet" href="{:REGISTER_PUBLIC}css/common/anime.min.css">
  <link rel="stylesheet" href="{:REGISTER_PUBLIC}css/user_card/user_card.css?v=<?php echo time(); php?>">
</head>

<body>
  <div id="app" :style="{'min-height': innerPage}" v-cloak>
    <div class="header">
      <div class="top_wrap">
        <div class="avatar">
          <img :src="guest.avatar" alt="">
        </div>
        <div class="uid">UID:{{guest.id}}</div>
        <div class="bottom">
          <p>{{guest.name || '尚未完善'}}</p>
          <span>丨</span>
          <p>{{guest.brand || '尚未完善'}}</p>
        </div>
      </div>
      <div class="btn_wrap">
        <div class="contact">
          <img src="{:REGISTER_PUBLIC}img/user_card/message_icon.png" alt="">
          <p>联系我</p>
        </div>
        <div>+关注</div>
      </div>
      <div class="sign_wrap" @click="goEditMsg('sign')">
        <img class="sign_icon" src="{:REGISTER_PUBLIC}img/user_card/tips_icon.png" alt="">
        <div class="sign van-multi-ellipsis--l2">{{guest.sign || '这个家伙很懒，什么都没有留下...'}}</div>
      </div>
    </div>
    <div class="container">
      <a class="item top_left">
        <img src="{:REGISTER_PUBLIC}img/user_card/sign_icon.png" alt="">
        <p>签到打卡</p>
      </a>
      <a class="item top_right">
        <img src="{:REGISTER_PUBLIC}img/user_card/friend_icon.png" alt="">
        <p>添加好友</p>
      </a>
      <a class="item left">
        <img src="{:REGISTER_PUBLIC}img/user_card/news_icon.png" alt="">
        <p>最新资讯</p>
      </a>
      <a class="item center">
        <img src="{:REGISTER_PUBLIC}img/user_card/home_icon.png" alt="">
        <p>我的主页</p>
      </a>
      <a class="item right">
        <img src="{:REGISTER_PUBLIC}img/user_card/track_icon.png" alt="">
        <p>人脉市集</p>
      </a>
      <a class="item bottom_left" href="">
        <img src="{:REGISTER_PUBLIC}img/user_card/show_icon.png" alt="">
        <p>我的风采</p>
      </a>
      <a class="item bottom_right" href="">
        <img src="{:REGISTER_PUBLIC}img/user_card/poster_icon.png" alt="">
        <p>我的海报</p>
      </a>
    </div>
    <a class="float_wrpa" href="/register/page/user_card" v-if="!isSelf">一键换成我的</a>
  </div>
</body>

<script src="{:REGISTER_PUBLIC}js/vue.min.js"></script>
<script src="{:REGISTER_PUBLIC}js/vue-resource.min.js"></script>
<script src="{:REGISTER_PUBLIC}js/vant.min.js?v=1.2"></script>

<script>
  const URL = "{:H5_DOMAIN}";

  new Vue({
    el: '#app',
    data() {
      return {
        token: '',
        mid: '', // 当前用户mid
        userInfo: {},
        guest: {}, // 个人信息
        isSelf: false, // 是否本人
      }
    },
    computed: {
      innerPage() {
        return window.innerHeight + 'px'
      }
    },
    mounted() {
      this.getUserInfo()
    },
    methods: {
      // 获取个人信息
      getUserInfo() {
        this.$http.get(URL + "/H5/Visitor/getLoginInfo").then(
          res => {
            const {
              errCode,
              data,
              msg
            } = res.body;
            if (errCode === 0) {
              this.token = data.token;
              this.userInfo = data.userInfo
              let mid = this.getQueryString('mid')
              if (mid) {
                this.mid = mid
                this.getGuestMsg(mid)
              } else {
                this.getGuestMsg(this.userInfo.mid)
              }
            }
          },
          err => {
            this.$toast({
              type: 'fail',
              message: '登录失败',
              duration: 1500,
            });
            console.log("getLoginInfo 请求失败");
          }
        );
      },
      // 获取用户信息
      getGuestMsg(mid) {
        this.$http.get(URL + "/register/friend/userinfo", {
          params: {
            token: this.token,
            uid: mid
          }
        }).then(
          res => {
            const {
              errCode,
              data,
              msg
            } = res.body;
            if (errCode === 0) {
              this.guest = data;
              let id = this.mid
              if (!id || id == this.userInfo.mid) {
                this.isSelf = true
              } else {
                this.isSelf = false
              }
            }
          },
          err => {
            console.log("getGuestMsg 请求失败");
          }
        );
      },
      // 关注请求
      getFocus() {
        this.$http.get(URL + "/register/friend/focus", {
          params: {
            token: this.token,
            focus_id: this.guest.id
          }
        }).then(
          res => {
            const {
              errCode,
              data,
              msg
            } = res.body;
            if (errCode === 0) {
              this.$toast({
                type: 'success',
                message: '关注成功',
                duration: 1500,
              });
              this.getGuestMsg(this.guest.id)
            } else {
              this.$toast({
                type: 'fail',
                message: msg,
                duration: 1500,
              });
            }
          },
          err => {
            console.log("getFocus 请求失败");
          }
        );
      },
      // 获取url参数
      getQueryString(name, url) {
        var url = url || window.location.href;
        var reg = new RegExp("(^|&|/?)" + name + "=([^&|/#?]*)(&|/?|$)", "i");
        var r = url.substr(1).match(reg);
        if (r != null) {
          return r[2];
        }
        return null;
      },
      // 跳转编辑信息
      goEditMsg(type) {
        if (!this.isSelf) {
          console.log('非本人');
          return false
        }
        switch (type) {
          case 'sign':
            location.href = URL + '/register/page/user_sign_edit'
            break;
          default:
            break;
        }
      },
    }
  })
</script>

</html>